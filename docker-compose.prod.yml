# =============================================================================
# Production Docker Compose
# Stellar Smart Contract DApp
#
# Usage:
#   docker compose -f docker-compose.prod.yml up -d --build
#   docker compose -f docker-compose.prod.yml down
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: stellar-dapp-postgres-prod
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-stellar_dapp}
      POSTGRES_USER: ${POSTGRES_USER:-stellar_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-stellar_user} -d ${POSTGRES_DB:-stellar_dapp}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - stellar-prod

  # ---------------------------------------------------------------------------
  # Redis Cache & Queue
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: stellar-dapp-redis-prod
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_prod_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - stellar-prod

  # ---------------------------------------------------------------------------
  # Backend API Server
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./packages/backend
      dockerfile: Dockerfile
    container_name: stellar-dapp-backend-prod
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-stellar_user}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-stellar_dapp}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      STELLAR_NETWORK: ${STELLAR_NETWORK:-testnet}
      STELLAR_HORIZON_URL: ${STELLAR_HORIZON_URL:-https://horizon-testnet.stellar.org}
      STELLAR_PASSPHRASE: ${STELLAR_PASSPHRASE:-Test SDF Network ; September 2015}
      SOROBAN_RPC_URL: ${SOROBAN_RPC_URL:-https://soroban-testnet.stellar.org}
      SOROBAN_NETWORK_PASSPHRASE: ${SOROBAN_NETWORK_PASSPHRASE:-Test SDF Network ; September 2015}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      FROM_EMAIL: ${FROM_EMAIL:-noreply@stellar-dapp.com}
      FROM_NAME: ${FROM_NAME:-Stellar DApp}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      CLIENT_PORTAL_URL: ${CLIENT_PORTAL_URL:-http://localhost/client}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-100}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      CONDITION_CHECK_INTERVAL: ${CONDITION_CHECK_INTERVAL:-300000}
      INVOICE_EXPIRATION_CHECK_INTERVAL: ${INVOICE_EXPIRATION_CHECK_INTERVAL:-3600000}
      TRANSACTION_SYNC_INTERVAL: ${TRANSACTION_SYNC_INTERVAL:-60000}
    ports:
      - "${BACKEND_PORT:-3001}:3001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - stellar-prod

  # ---------------------------------------------------------------------------
  # Frontend (Nginx + React SPA)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./packages/frontend
      dockerfile: Dockerfile
    container_name: stellar-dapp-frontend-prod
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - stellar-prod

volumes:
  postgres_prod_data:
    driver: local
  redis_prod_data:
    driver: local

networks:
  stellar-prod:
    name: stellar-dapp-prod-network
    driver: bridge
